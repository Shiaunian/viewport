<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è‡ªæˆ‘æ”¹é€ æ‰€ï½œç™»å…¥</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1720;
      --card2:#0c141c;
      --text:#e9f0ff;
      --muted:#9bb0c9;
      --line:rgba(255,255,255,.08);
      --accent:#8bd2ff;
      --accent2:#a8ffcf;
      --danger:#ff6b6b;
      --ok:#35d07f;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 10% -10%, rgba(139,210,255,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(168,255,207,.12), transparent 55%),
        radial-gradient(900px 600px at 50% 120%, rgba(139,210,255,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 16px 34px;
    }
    .shell{
      width:min(460px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 4px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        linear-gradient(135deg, rgba(139,210,255,.9), rgba(168,255,207,.75));
      box-shadow: 0 10px 30px rgba(139,210,255,.18);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 60%);
      transform: rotate(20deg);
    }
    .brand h1{
      font-size:18px;
      margin:0;
      letter-spacing:.6px;
    }
    .brand p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 40%), var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .hero{
      padding:18px 18px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(139,210,255,.06), transparent 55%);
    }
    .hero .title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hero h2{
      margin:0;
      font-size:16px;
      letter-spacing:.4px;
    }
    .chip{
      font-size:12px;
      color:rgba(233,240,255,.9);
      border:1px solid rgba(139,210,255,.22);
      background: rgba(139,210,255,.08);
      padding:6px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .hero .quote{
      margin:10px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.65;
    }
    .bullets{
      margin:10px 0 0;
      padding-left:18px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.65;
    }
    .bullets li{margin:4px 0}

    .tabs{
      display:flex;
      gap:8px;
      padding:12px 12px 0;
    }
    .tab{
      flex:1;
      border:1px solid var(--line);
      background: var(--card2);
      color: rgba(233,240,255,.85);
      padding:10px 12px;
      border-radius: 14px;
      font-size:14px;
      cursor:pointer;
      transition: transform .05s ease, border-color .18s ease, background .18s ease;
      user-select:none;
    }
    .tab:active{transform: scale(.99)}
    .tab.active{
      border-color: rgba(139,210,255,.25);
      background: rgba(139,210,255,.08);
      color: var(--text);
    }

    form{
      padding:14px 14px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size:12.5px;
      color: rgba(233,240,255,.88);
    }
    input{
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:12px 12px;
      font-size:15px;
      outline:none;
    }
    input::placeholder{color: rgba(155,176,201,.55)}
    input:focus{
      border-color: rgba(139,210,255,.35);
      box-shadow: 0 0 0 4px rgba(139,210,255,.10);
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top:4px;
    }
    .btn{
      flex:1;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:12px 12px;
      font-size:15px;
      cursor:pointer;
      transition: transform .05s ease, background .18s ease, border-color .18s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn.primary{
      border-color: rgba(139,210,255,.22);
      background: linear-gradient(135deg, rgba(139,210,255,.22), rgba(168,255,207,.14));
    }
    .btn:active{transform: scale(.99)}
    .btn[disabled]{opacity:.55; cursor:not-allowed}

    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.6;
      padding:0 14px 14px;
    }
    .hint code{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:2px 6px;
      border-radius: 10px;
      font-size: 12px;
    }

    .toast{
      margin:0 14px 14px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: rgba(233,240,255,.92);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space:pre-wrap;
    }
    .toast.show{display:block}
    .toast.ok{
      border-color: rgba(53,208,127,.25);
      background: rgba(53,208,127,.10);
    }
    .toast.bad{
      border-color: rgba(255,107,107,.25);
      background: rgba(255,107,107,.10);
    }

    .footer{
      padding:10px 4px 0;
      color: rgba(155,176,201,.7);
      font-size:12px;
      text-align:center;
      line-height:1.5;
    }

    .mini{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:0 14px 14px;
      color: rgba(155,176,201,.8);
      font-size:12px;
    }
    .mini a{
      color: rgba(139,210,255,.9);
      text-decoration:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>è‡ªæˆ‘æ”¹é€ æ‰€</h1>
          <p>ä¸æ˜¯ä¾†è¢«è©•åƒ¹ï¼Œæ˜¯ä¾†å‡ç´šè‡ªå·±ã€‚</p>
        </div>
      </div>

      <div class="card">
        <div class="hero">
          <div class="title">
            <h2>è©¦ç…‰å…¥å£</h2>
            <div class="chip">å¯è¦–åŒ–çš„é€²åŒ–</div>
          </div>
          <div class="quote">
            è‡ªå­¸æœ€ç—›è‹¦çš„ä¸æ˜¯é›£ï¼Œæ˜¯ä¸çŸ¥é“è‡ªå·±åˆ°åº•åœ¨ç¬¬å¹¾éšæ®µã€‚<br/>
            åœ¨é€™è£¡ï¼Œä½ æ—¢æ˜¯å¯¦é©—é«”ï¼Œä¹Ÿæ˜¯æ”¹é€ å¸«ã€‚
          </div>
          <ul class="bullets">
            <li>ğŸ” æƒæèƒ½åŠ›çµæ§‹</li>
            <li>ğŸ§© æ‰¾å‡ºçŸ­æ¿èˆ‡æ½›åŠ›</li>
            <li>âš”ï¸ ç”¨é—œå¡å–ä»£æ¯ç‡¥æ¸¬é©—</li>
            <li>ğŸ“ˆ çœ‹è¦‹èƒ½åŠ›æ›²ç·šï¼Œè€Œä¸æ˜¯åªæœ‰åˆ†æ•¸</li>
            <li>ğŸ·ï¸ å»ºç«‹ä½ çš„èƒ½åŠ›æ¨™ç±¤èˆ‡ç¨±è™Ÿ</li>
          </ul>
        </div>

        <div class="tabs">
          <button id="tabLogin" class="tab active" type="button">ç™»å…¥</button>
          <button id="tabRegister" class="tab" type="button">æ–°ç”¨æˆ¶è¨»å†Š</button>
        </div>

        <div id="toast" class="toast" role="status" aria-live="polite"></div>

        <!-- Login Form -->
        <form id="loginForm" autocomplete="on">
          <div class="row">
            <label for="loginEmail">å¸³è™Ÿï¼ˆEmailï¼‰</label>
            <input id="loginEmail" type="email" inputmode="email" placeholder="yourname@email.com" required />
          </div>
          <div class="row">
            <label for="loginPassword">å¯†ç¢¼</label>
            <input id="loginPassword" type="password" placeholder="è‡³å°‘ 6 å€‹å­—å…ƒ" minlength="6" required />
          </div>

          <div class="actions">
            <button id="loginBtn" class="btn primary" type="submit">ç™»å…¥</button>
          </div>
        </form>

        <!-- Register Form -->
        <form id="registerForm" style="display:none" autocomplete="on">
          <div class="row">
            <label for="regEmail">å¸³è™Ÿï¼ˆEmailï¼‰</label>
            <input id="regEmail" type="email" inputmode="email" placeholder="yourname@email.com" required />
          </div>
          <div class="row">
            <label for="regPassword">å¯†ç¢¼</label>
            <input id="regPassword" type="password" placeholder="è‡³å°‘ 6 å€‹å­—å…ƒ" minlength="6" required />
          </div>
          <div class="row">
            <label for="regName">ç”¨æˆ¶åç¨±ï¼ˆå¯ä¸­æ–‡ï¼‰</label>
            <input id="regName" type="text" placeholder="ä¾‹å¦‚ï¼šå¿µå¿µ" maxlength="20" required />
          </div>

          <div class="actions">
            <button id="registerBtn" class="btn primary" type="submit">è¨»å†Šä¸¦é€²å…¥è©¦ç…‰</button>
          </div>
        </form>

        <div class="mini">
          <span>æç¤ºï¼šå»ºè­°é–‹å•Ÿç€è¦½å™¨ã€Œè¨˜ä½å¯†ç¢¼ã€</span>
          <a href="#" id="demoFill">ä¸€éµå¡«å…¥æ¸¬è©¦</a>
        </div>

        <div class="hint">
          å¾Œç«¯å„²å­˜ä½ç½®ï¼š<code>Realtime Database /users/&lt;uid&gt;</code><br/>
          è¨»å†ŠæˆåŠŸæœƒåŒæ­¥å¯«å…¥ï¼š<code>email</code>ã€<code>username</code>ã€<code>createdAt</code>ã€‚<br/>
          ç”¨æˆ¶åç¨±å”¯ä¸€æ€§ï¼š<code>Realtime Database /usernames/&lt;nameKey&gt;</code>
        </div>
      </div>

      <div class="footer">
        Â© è‡ªæˆ‘æ”¹é€ æ‰€ Â· ä½ ä¸æ˜¯å‡ç´šï¼Œä½ æ˜¯åœ¨é‡æ§‹ã€‚
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK (Web v9 modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      runTransaction,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDXesKYLI2T_DGR9uxqdbvoqpEMBY43cT8",
      authDomain: "my-awesome-project-id-1c490.firebaseapp.com",
      databaseURL: "https://my-awesome-project-id-1c490-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "my-awesome-project-id-1c490",
      storageBucket: "my-awesome-project-id-1c490.firebasestorage.app",
      messagingSenderId: "32958547583",
      appId: "1:32958547583:web:a02b77fff42c9ab70b614a"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI helpers
    const tabLogin = document.getElementById("tabLogin");
    const tabRegister = document.getElementById("tabRegister");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const toast = document.getElementById("toast");

    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");

    function showToast(message, type="ok"){
      toast.textContent = message;
      toast.className = "toast show " + (type === "bad" ? "bad" : "ok");
    }
    function clearToast(){
      toast.className = "toast";
      toast.textContent = "";
    }
    function setLoading(btn, loading){
      btn.disabled = loading;
      btn.textContent = loading ? "è™•ç†ä¸­â€¦" : btn.dataset.label;
    }

    // Preserve button labels
    loginBtn.dataset.label = loginBtn.textContent;
    registerBtn.dataset.label = registerBtn.textContent;

    function switchMode(mode){
      clearToast();
      if(mode === "login"){
        tabLogin.classList.add("active");
        tabRegister.classList.remove("active");
        loginForm.style.display = "";
        registerForm.style.display = "none";
      }else{
        tabRegister.classList.add("active");
        tabLogin.classList.remove("active");
        loginForm.style.display = "none";
        registerForm.style.display = "";
      }
    }

    tabLogin.addEventListener("click", () => switchMode("login"));
    tabRegister.addEventListener("click", () => switchMode("register"));

    // Demo fill
    document.getElementById("demoFill").addEventListener("click", (e)=>{
      e.preventDefault();
      document.getElementById("regEmail").value = "test+" + Math.floor(Math.random()*10000) + "@example.com";
      document.getElementById("regPassword").value = "123456";
      document.getElementById("regName").value = "æ¸¬è©¦æ”¹é€ å¸«";
      switchMode("register");
      showToast("å·²å¡«å…¥æ¸¬è©¦è³‡æ–™ï¼ˆè¨˜å¾—æ”¹æˆä½ è‡ªå·±çš„å¸³è™Ÿå–”ï¼‰", "ok");
    });

    // ===== åç¨±å”¯ä¸€ï¼šæŠŠä½¿ç”¨è€…è¼¸å…¥çš„åå­—è½‰æˆå¯ç•¶ key çš„ nameKey =====
    function normalizeUsernameKey(name){
      let n = String(name || "").trim();
      // å…¨å½¢ç©ºç™½ â†’ åŠå½¢ç©ºç™½ï¼Œä¸¦åˆä½µå¤šå€‹ç©ºç™½
      n = n.replace(/\u3000/g, " ").replace(/\s+/g, " ");
      // è‹±æ–‡å¤§å°å¯«è¦–ç‚ºåŒåï¼ˆé¿å… A / a å…©å€‹äººé‘½æ¼æ´ï¼‰
      n = n.toLowerCase();
      // Firebase key ç¦æ­¢å­—å…ƒï¼š. # $ [ ] /
      n = n.replace(/[.#$\[\]\/]/g, "_");
      return encodeURIComponent(n);
    }

    async function isUsernameTaken(username){
      const key = normalizeUsernameKey(username);
      if(!key) return true;
      const snap = await get(ref(db, "usernames/" + key));
      return snap.exists();
    }

    // Register
    registerForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearToast();

      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;
      const username = document.getElementById("regName").value.trim();

      if(!username){
        showToast("è«‹è¼¸å…¥ç”¨æˆ¶åç¨±ï¼ˆå¯ä¸­æ–‡ï¼‰ã€‚", "bad");
        return;
      }
      if(password.length < 6){
        showToast("å¯†ç¢¼è‡³å°‘ 6 å€‹å­—å…ƒï¼Œå¦å‰‡æ”¹é€ æ‰€æœƒè¦ºå¾—ä½ å¤ªéš¨ä¾¿ ğŸ˜", "bad");
        return;
      }

      try{
        setLoading(registerBtn, true);

        // 0) å…ˆæª¢æŸ¥åŒåï¼ˆåŒåä¸çµ¦è¨»å†Šï¼‰
        const taken = await isUsernameTaken(username);
        if(taken){
          showToast("é€™åå­æœ‰äººä½¿ç”¨éè«‹å¾æ–°è¼¸å…¥", "bad");
          return;
        }

        // 1) Create Auth user
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;

        // 2) ç”¨ transaction ä½”ç”¨åå­—ï¼ˆé¿å…åŒæ™‚æ¶åï¼‰
        const nameKey = normalizeUsernameKey(username);
        const nameRef = ref(db, "usernames/" + nameKey);

        const tx = await runTransaction(nameRef, (current) => {
          if(current !== null){
            return; // å·²å­˜åœ¨ â†’ ä¸ commit
          }
          return {
            uid,
            username,
            createdAt: Date.now()
          };
        });

        if(!tx.committed){
          // åå­—è¢«åˆ¥äººæ¶å…ˆç”¨äº†ï¼šåˆªæ‰å‰›å‰›å»ºç«‹çš„å¸³è™Ÿï¼ˆé¿å…å¹½éˆå¸³è™Ÿï¼‰
          try{ await cred.user.delete(); }catch(_){}
          showToast("é€™åå­æœ‰äººä½¿ç”¨éè«‹å¾æ–°è¼¸å…¥", "bad");
          return;
        }

        // 3) Update displayName (Auth profile)
        await updateProfile(cred.user, { displayName: username });

        // 4) Save profile to Realtime Database
        await set(ref(db, "users/" + uid), {
          uid,
          email,
          username,
          usernameKey: nameKey,
          createdAt: serverTimestamp()
        });

        showToast("è¨»å†ŠæˆåŠŸ âœ… é€²å…¥è©¦ç…‰å¤§å»³ï¼", "ok");
        window.location.href = "./exam_fixed.html"; // âœ… ç›´æ¥è·³è½‰

      }catch(err){
        console.error(err);
        showToast(prettyFirebaseError(err), "bad");
      }finally{
        setLoading(registerBtn, false);
      }
    });

    // Login
    loginForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearToast();

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      try{
        setLoading(loginBtn, true);

        await signInWithEmailAndPassword(auth, email, password);
        showToast("ç™»å…¥æˆåŠŸ âœ… é€²å…¥è©¦ç…‰å¤§å»³â€¦", "ok");
        window.location.href = "./exam_fixed.html"; // âœ… ç›´æ¥è·³è½‰

      }catch(err){
        console.error(err);
        showToast(prettyFirebaseError(err), "bad");
      }finally{
        setLoading(loginBtn, false);
      }
    });

    // Firebase error mapping (è®“è¨Šæ¯æ¯”è¼ƒäººè©±)
    function prettyFirebaseError(err){
      const code = (err && err.code) ? err.code : "";
      switch(code){
        case "auth/invalid-email": return "å¸³è™Ÿæ ¼å¼ä¸å°ï¼šè«‹è¼¸å…¥ Emailï¼ˆä¾‹å¦‚ name@gmail.comï¼‰ã€‚";
        case "auth/email-already-in-use": return "é€™å€‹å¸³è™Ÿå·²ç¶“è¨»å†Šéäº†ï¼Œè«‹ç›´æ¥ç™»å…¥ã€‚";
        case "auth/weak-password": return "å¯†ç¢¼å¤ªå¼±äº†â€¦è‡³å°‘ 6 å€‹å­—å…ƒèµ·è·³ã€‚";
        case "auth/user-not-found": return "æ‰¾ä¸åˆ°é€™å€‹å¸³è™Ÿï¼Œå¯èƒ½ä½ é‚„æ²’è¨»å†Šã€‚";
        case "auth/wrong-password": return "å¯†ç¢¼ä¸å°å–”ï¼Œå†æƒ³ä¸€ä¸‹ï¼ˆä¸è¦çªæˆ‘ğŸ˜…ï¼‰ã€‚";
        case "auth/too-many-requests": return "å˜—è©¦å¤ªå¤šæ¬¡äº†ï¼Œå…ˆä¼‘æ¯ä¸€ä¸‹å†è©¦ã€‚";
        default:
          return "ç™¼ç”ŸéŒ¯èª¤ï¼š" + (err?.message || "æœªçŸ¥éŒ¯èª¤");
      }
    }
  </script>
</body>
</html>
