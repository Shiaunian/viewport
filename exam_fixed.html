<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è‡ªæˆ‘æ”¹é€ æ‰€ï½œè€ƒè©¦ç³»çµ±</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#0b0f14; --card:#0f1720; --card2:#0c141c;
      --text:#e9f0ff; --muted:#9bb0c9; --line:rgba(255,255,255,.08);
      --accent:#8bd2ff; --ok:#35d07f; --danger:#ff6b6b;
      --shadow: 0 18px 60px rgba(0,0,0,.45); --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 10% -10%, rgba(139,210,255,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(168,255,207,.12), transparent 55%),
        radial-gradient(900px 600px at 50% 120%, rgba(139,210,255,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      padding: 20px 14px 28px;
      display:flex; justify-content:center;
    }
    .wrap{ width:min(520px, 100%); display:flex; flex-direction:column; gap:12px; }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 6px;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(139,210,255,.9), rgba(168,255,207,.75));
      box-shadow: 0 10px 30px rgba(139,210,255,.18);
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.6px;}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted);}

    .btn{
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
    }
    .btn.primary{
      border-color: rgba(139,210,255,.22);
      background: linear-gradient(135deg, rgba(139,210,255,.22), rgba(168,255,207,.14));
      font-weight:800;
      letter-spacing:.06em;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 40%), var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero{
      padding: 14px 14px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(139,210,255,.06), transparent 55%);
    }
    .hero .row{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .chip{
      font-size:12px;
      border:1px solid rgba(139,210,255,.22);
      background: rgba(139,210,255,.08);
      padding:6px 10px; border-radius:999px;
      color: rgba(233,240,255,.92);
      white-space:nowrap;
    }
    .userbar{
      margin-top:10px;
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(53,208,127,.18);
      background: rgba(53,208,127,.10);
      color: rgba(233,240,255,.92);
      font-size:13px;
      line-height:1.5;
    }
    .avatar{
      width:36px; height:36px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      object-fit:cover;
      flex:0 0 auto;
    }
    .usertext{display:flex; flex-direction:column; gap:2px;}
    .panel{ padding: 12px 14px 14px; display:flex; flex-direction:column; gap:10px; }
    label{ font-size:12.5px; color: rgba(233,240,255,.88); }
    select{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:12px 12px;
      font-size:15px;
      outline:none;
    }
    .hint{font-size:12px; color:var(--muted); line-height:1.6;}
    .toast{
      margin: 10px 14px 0;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: rgba(233,240,255,.92);
      font-size:13px;
      line-height:1.5;
      display:none;
      white-space:pre-wrap;
    }
    .toast.show{display:block}
    .toast.ok{ border-color: rgba(53,208,127,.25); background: rgba(53,208,127,.10); }
    .toast.bad{ border-color: rgba(255,107,107,.25); background: rgba(255,107,107,.10); }

    /* ===== Modal Exam ===== */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 18px 12px;
      z-index: 999;
    }
    .modal.show{display:flex}
    .modal-card{
      width:min(520px, 100%);
      max-height: 86vh;
      background: #0f1720;
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modal-head{
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      background: linear-gradient(180deg, rgba(139,210,255,.06), transparent 55%);
    }
    .modal-title{font-weight:900; letter-spacing:.06em}
    .modal-sub{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.4;}
    .close{
      border:none; background:transparent; color:rgba(233,240,255,.85);
      font-size:18px; cursor:pointer;
    }
    .modal-body{ padding: 12px; overflow:auto; }
    .qbox{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 10px;
    }
    .qmeta{display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--muted); margin-bottom:6px;}
    .badge{padding:2px 10px; border-radius:999px; background: rgba(139,210,255,.14); border:1px solid rgba(139,210,255,.22); color:rgba(233,240,255,.92); font-size:11px;}
    .qtext{font-size:14px; line-height:1.6; margin: 2px 0 8px; color:rgba(233,240,255,.95);}
    .qimg{border-radius: 14px; overflow:hidden; border:1px solid rgba(255,255,255,.08); background:#111; margin-bottom:8px; display:none;}
    .qimg img{width:100%; height:auto; display:block;}
    .opts{display:flex; flex-direction:column; gap:8px; margin-top:8px;}
    .opt{
      border:none;
      border-radius: 14px;
      padding: 10px 10px;
      font-size:16px;
      text-align:left;
      background: rgba(139,210,255,.10);
      border:1px solid rgba(139,210,255,.12);
      color: rgba(233,240,255,.95);
      cursor:pointer;
      position:relative;
    }
    .opt:active{transform: scale(.99)}
    .opt.correct{ background: rgba(53,208,127,.12); border-color: rgba(53,208,127,.28); }
    .opt.wrong{ background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.28); }
    .opt.correct::after{content:"âœ”"; position:absolute; right:10px; top:50%; transform:translateY(-50%); color: var(--ok); font-weight:900;}
    .opt.wrong::after{content:"âœ˜"; position:absolute; right:10px; top:50%; transform:translateY(-50%); color: var(--danger); font-weight:900;}

    .modal-foot{
      border-top:1px solid var(--line);
      padding: 10px 12px 12px;
      display:flex; gap:10px;
    }
    .grow{flex:1}
    .report{
      margin-top:10px;
      padding:10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      display:none;
    }
    .report h3{margin:0 0 8px; font-size:14px; letter-spacing:.06em;}
    .rline{font-size:12.5px; color:rgba(233,240,255,.9); line-height:1.5; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.10);}
    .rline:last-child{border-bottom:none}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>è‡ªæˆ‘æ”¹é€ æ‰€ï½œè€ƒè©¦ç³»çµ±</h1>
          <p>é¸ä¸€å€‹é¡Œåº«ï¼ŒæŠ½ 20 é¡Œï¼ŒæŠŠè‡ªå·±å‡ç´šã€‚</p>
        </div>
      </div>
      <button id="logoutBtn" class="btn">ç™»å‡º</button>
    </div>

    <div class="card">
      <div class="hero">
        <div class="row">
          <div>
            <div id="hallTitle" class="modal-title">è©¦ç…‰å¤§å»³</div>
            <div id="hallSub" class="modal-sub">ä½ ä¸æ˜¯ä¾†è¢«è©•åƒ¹ï¼Œä½ æ˜¯ä¾†é‡æ§‹è‡ªå·±ã€‚</div>
          </div>
          <div class="chip">20 é¡Œï½œ100 åˆ†</div>
        </div>

        <div id="userBar" class="userbar">ç›®å‰ç™»å…¥ï¼šè¼‰å…¥ä¸­â€¦</div>
      </div>

      <div id="toast" class="toast"></div>

      <div class="panel">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="modeExamBtn" class="btn primary" type="button" style="flex:1; min-width:150px;">è©¦ç…‰å¤§å»³</button>
          <button id="modeReviewBtn" class="btn" type="button" style="flex:1; min-width:150px;">è¤‡ç¿’å¤§å»³</button>
        </div>

        <div>
          <label for="mainSelect">ä¸»åˆ†é¡</label>
          <select id="mainSelect">
            <option value="">è«‹é¸æ“‡â€¦</option>
          </select>
        </div>

        <div>
          <label for="bankSelect">ä¸»é¡Œ</label>
          <select id="bankSelect" disabled>
            <option value="">è«‹å…ˆé¸ä¸»åˆ†é¡â€¦</option>
          </select>
        </div>

        

        <div>
          <label for="subBankSelect">è€ƒè©¦é …ç›®</label>
          <select id="subBankSelect" disabled>
            <option value="">è«‹å…ˆé¸ä¸»é¡Œâ€¦</option>
          </select>
        </div>

        <button id="leaderBtn" class="btn" style="display:none;">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>

        <button id="startBtn" class="btn primary" disabled>é–‹å§‹è€ƒè©¦</button>
      </div>
    </div>
  </div>

  <!-- Exam Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div id="modalTitle" class="modal-title">é¡Œç›®</div>
          <div id="modalSub" class="modal-sub">â€”</div>
        </div>
        <button id="closeBtn" class="close" title="é—œé–‰">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="qbox">
          <div class="qmeta">
            <div id="qIndex">ç¬¬ 1 / 20 é¡Œ</div>
            <div class="badge" id="scoreBadge">0 åˆ†</div>
          </div>
          <div id="qText" class="qtext"></div>
          <div class="qtools" style="margin:6px 0 10px;">
            <button id="playBtn" class="btn" type="button" style="display:none;">ğŸ”Š æ’­æ”¾</button>
          </div>
          <div id="qImg" class="qimg"><img alt="question" /></div>
          <div id="opts" class="opts"></div>
        </div>

        <div id="report" class="report">
          <h3>ç­”é¡Œæ¯”å°å ±å‘Š</h3>
          <div id="reportList"></div>
        </div>
      </div>

      <div class="modal-foot">
        <button id="nextBtn" class="btn primary grow" disabled>ä¸‹ä¸€é¡Œ</button>
      </div>
    </div>
  </div>


  <!-- Leaderboard Modal -->
  <div id="lbModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div id="lbTitle" class="modal-title">æ’è¡Œæ¦œ</div>
          <div id="lbSub" class="modal-sub">â€”</div>
        </div>
        <button id="lbCloseBtn" class="close" title="é—œé–‰">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="qbox">
          <div class="qmeta">
            <div class="muted">å…¬é–‹æ’è¡Œæ¦œï½œåªæœƒè¨ˆç®—æœ€æ–°åˆ†æ•¸</div>
            <div class="badge" id="lbCount">0 äºº</div>
          </div>
          <div id="lbList" class="opts"></div>
          
        </div>
      </div>
      <div class="modal-foot">
        <button id="lbRefreshBtn" class="btn primary grow">æ›´æ–°æ’è¡Œæ¦œ</button>
      </div>
    </div>
  </div>



  <!-- Review Modal -->
  <div id="rvModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div id="rvTitle" class="modal-title">è¤‡ç¿’</div>
          <div id="rvSub" class="modal-sub">â€”</div>
        </div>
        <button id="rvCloseBtn" class="close" title="é—œé–‰">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="qbox">
          <div class="qmeta">
            <div class="muted">é» ğŸ”Š æ’­æ”¾ï½œé»æ•´è¡Œå¯è¤‡è£½æ–‡å­—</div>
            <div class="badge" id="rvCount">0 ç­†</div>
          </div>
          <div id="rvList" class="opts"></div>
        </div>
      </div>
      <div class="modal-foot">
        <button id="rvCloseBtn2" class="btn primary grow">é—œé–‰</button>
      </div>
    </div>
  </div>


  <!-- é¡Œåº«ï¼ˆå…ˆç”¨ä½ ç¾æœ‰çš„ç¯„ä¾‹ï¼Œä¹‹å¾Œä½ å¯ä»¥æ›æˆæ›´å¤šæª”ï¼‰ -->
<!-- â†‘ ä½ æä¾›çš„é¡Œåº«ç¯„ä¾‹å°±æ˜¯é€™ç¨®æ ¼å¼-->

    <script src="./èªè¨€.js"></script>
    <script src="./å·¥ç¨‹.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getDatabase, ref, get, set, update, query, orderByChild, limitToLast, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDXesKYLI2T_DGR9uxqdbvoqpEMBY43cT8",
      authDomain: "my-awesome-project-id-1c490.firebaseapp.com",
      databaseURL: "https://my-awesome-project-id-1c490-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "my-awesome-project-id-1c490",
      storageBucket: "my-awesome-project-id-1c490.firebasestorage.app",
      messagingSenderId: "32958547583",
      appId: "1:32958547583:web:a02b77fff42c9ab70b614a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ===== UI =====
    const userBar = document.getElementById("userBar");
    const toast = document.getElementById("toast");
    const mainSelect = document.getElementById("mainSelect");
    const bankSelect = document.getElementById("bankSelect");
    const subBankSelect = document.getElementById("subBankSelect");
    const startBtn = document.getElementById("startBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const leaderBtn = document.getElementById("leaderBtn");

    // ===== å¤§å»³æ¨¡å¼ï¼ˆè©¦ç…‰ / è¤‡ç¿’ï¼‰=====
    const hallTitle = document.getElementById("hallTitle");
    const hallSub = document.getElementById("hallSub");
    const modeExamBtn = document.getElementById("modeExamBtn");
    const modeReviewBtn = document.getElementById("modeReviewBtn");

    // ===== è¤‡ç¿’ Modal UI =====
    const rvModal = document.getElementById("rvModal");
    const rvTitle = document.getElementById("rvTitle");
    const rvSub = document.getElementById("rvSub");
    const rvList = document.getElementById("rvList");
    const rvCount = document.getElementById("rvCount");
    const rvCloseBtn = document.getElementById("rvCloseBtn");
    const rvCloseBtn2 = document.getElementById("rvCloseBtn2");

    const modal = document.getElementById("modal");
    const closeBtn = document.getElementById("closeBtn");
    const nextBtn = document.getElementById("nextBtn");
    const qIndex = document.getElementById("qIndex");
    const scoreBadge = document.getElementById("scoreBadge");
    const qText = document.getElementById("qText");
    const qImg = document.getElementById("qImg");
    const qImgTag = qImg.querySelector("img");
    const opts = document.getElementById("opts");
    const report = document.getElementById("report");
    const reportList = document.getElementById("reportList");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const playBtn = document.getElementById("playBtn");

    // ===== æ’è¡Œæ¦œ UI =====
    const lbModal = document.getElementById("lbModal");
    const lbCloseBtn = document.getElementById("lbCloseBtn");
    const lbRefreshBtn = document.getElementById("lbRefreshBtn");
    const lbTitle = document.getElementById("lbTitle");
    const lbSub = document.getElementById("lbSub");
    const lbList = document.getElementById("lbList");
    const lbCount = document.getElementById("lbCount");

    let audioPlayer = null;
    let hallMode = "exam"; // "exam" | "review"

    function stopAudio(){
      try{
        if(audioPlayer){
          audioPlayer.pause();
          audioPlayer.currentTime = 0;
        }
      }catch(e){}
    }

    // ===== ç­‰ç´š / ç¶“é©— =====
    // è¦å‰‡ï¼šæ¯å€‹ã€Œè€ƒè©¦é …ç›®ã€åªè¨ˆç®—ä¸€æ¬¡ï¼ˆæœ€æ–°åˆ†æ•¸è¦†è“‹èˆŠåˆ†æ•¸ï¼‰ï¼Œç¸½ç¶“é©—å€¼ = å„è€ƒè©¦é …ç›®æœ€æ–°åˆ†æ•¸ç¸½å’Œã€‚
    // ä½ å¯ä»¥ä¹‹å¾Œå†å¾®èª¿é–€æª»ï¼ˆä¾‹å¦‚æ”¹æˆ 100ã€300ã€600...ï¼‰ã€‚
    function calcLevel(xp){
      const v = Number(xp || 0);
      return 1 + Math.floor(Math.max(0, v) / 200);
    }

    function é¡Œåº«è¶³å¤ (bankKey){
      const bank = window.QUESTION_BANK?.[bankKey];
      return Array.isArray(bank) && bank.length >= é¡Œæ•¸é–€æª»;
    }

    function showToast(message, type="ok"){
      toast.textContent = message;
      toast.className = "toast show " + (type === "bad" ? "bad" : "ok");
    }
    function clearToast(){ toast.className = "toast"; toast.textContent = ""; }

    if(location.protocol === "file:"){
      showToast("âš ï¸ ä½ ç›®å‰ç”¨ file:// é–‹å•Ÿï¼Œç€è¦½å™¨æœƒå°é– Firebaseï¼ˆæ’è¡Œæ¦œå¯«å…¥æœƒå¤±æ•—ï¼‰ã€‚\n\nè«‹ç”¨æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿï¼š\n- VSCode â†’ Live Server\n- æˆ–çµ‚ç«¯æ©Ÿï¼š npx http-server .\n\nç”¨ http://localhost é€²å…¥ã€‚", "bad");
    }

    // é¡Œåº«è‡³å°‘è¦æœ‰é€™å€‹é¡Œæ•¸ï¼Œæ‰æœƒå‡ºç¾åœ¨ç¬¬ä¸‰å±¤ï¼ˆæ¬¡åˆ†é¡ï¼‰åˆ—è¡¨
    const é¡Œæ•¸é–€æª» = 20;

    // ===== åˆ†é¡ï¼ˆç¬¬ä¸€å±¤ï¼‰â†’ ä½ å¯ä»¥éš¨æ™‚æ“´å…… =====
    // bankKey è¦å°å¾—ä¸Š window.QUESTION_BANK çš„ key
    // åˆ†é¡è³‡æ–™æ”¹ç‚ºå¾ window.åˆ†é¡æ¨¹ è®€å–ï¼ˆç”±å„é¡Œåº« JS æä¾›ï¼‰

    // æŠŠ åˆ†é¡æ¨¹ å¡«å…¥ä¸»åˆ†é¡ä¸‹æ‹‰
    function initTreeUI(){
      const tree = window.åˆ†é¡æ¨¹ || {};
      mainSelect.innerHTML = "";
      mainSelect.appendChild(new Option("è«‹é¸æ“‡â€¦", ""));

      const mains = Object.keys(tree);
      for(const m of mains){
        mainSelect.appendChild(new Option(m, m));
      }

      bankSelect.disabled = true;
      bankSelect.innerHTML = '<option value="">è«‹å…ˆé¸ä¸»åˆ†é¡â€¦</option>';

      subBankSelect.disabled = true;
      subBankSelect.innerHTML = '<option value="">è«‹å…ˆé¸ä¸»é¡Œâ€¦</option>';

      startBtn.disabled = true;
      setHallMode(hallMode);
    }


    function setHallMode(mode){
      hallMode = (mode === "review") ? "review" : "exam";

      if(hallMode === "exam"){
        hallTitle.textContent = "è©¦ç…‰å¤§å»³";
        hallSub.textContent = "ä½ ä¸æ˜¯ä¾†è¢«è©•åƒ¹ï¼Œä½ æ˜¯ä¾†é‡æ§‹è‡ªå·±ã€‚";
        modeExamBtn.classList.add("primary");
        modeReviewBtn.classList.remove("primary");
        startBtn.textContent = "é–‹å§‹è€ƒè©¦";
        // æ’è¡Œæ¦œï¼šåªæœ‰è©¦ç…‰å¤§å»³æœƒç”¨åˆ°
        if(subBankSelect.value && currentBankKey){
          leaderBtn.style.display = "inline-flex";
        }
      }else{
        hallTitle.textContent = "è¤‡ç¿’å¤§å»³";
        hallSub.textContent = "ä¸è€ƒè©¦ï¼Œä¸æ’è¡Œï¼›æŠŠå¥å­/å–®å­—ç·´åˆ°åˆ»é€²è‚Œè‚‰è¨˜æ†¶ã€‚";
        modeReviewBtn.classList.add("primary");
        modeExamBtn.classList.remove("primary");
        startBtn.textContent = "é–‹å§‹è¤‡ç¿’";
        leaderBtn.style.display = "none";
      }
    }

    modeExamBtn.addEventListener("click", () => setHallMode("exam"));
    modeReviewBtn.addEventListener("click", () => setHallMode("review"));

    mainSelect.addEventListener("change", () => {
      clearToast();
      const ä¸»åˆ†é¡ = mainSelect.value;

      // reset
      startBtn.disabled = true;

      bankSelect.innerHTML = "";
      subBankSelect.innerHTML = "";

      subBankSelect.disabled = true;
      subBankSelect.innerHTML = '<option value="">è«‹å…ˆé¸ä¸»é¡Œâ€¦</option>';

      if(!ä¸»åˆ†é¡){
        bankSelect.disabled = true;
        bankSelect.innerHTML = '<option value="">è«‹å…ˆé¸ä¸»åˆ†é¡â€¦</option>';
        return;
      }

      const å­åˆ—è¡¨ = Object.keys(window.åˆ†é¡æ¨¹?.[ä¸»åˆ†é¡] || {});
      bankSelect.disabled = false;
      bankSelect.appendChild(new Option("è«‹é¸ä¸»é¡Œâ€¦", ""));
      for(const å­åˆ†é¡ of å­åˆ—è¡¨){
        bankSelect.appendChild(new Option(å­åˆ†é¡, å­åˆ†é¡));
      }
    });

    bankSelect.addEventListener("change", () => {
      clearToast();
      const ä¸»åˆ†é¡ = mainSelect.value;
      const å­åˆ†é¡ = bankSelect.value;

      startBtn.disabled = true;
      subBankSelect.innerHTML = "";

      if(!ä¸»åˆ†é¡ || !å­åˆ†é¡){
        subBankSelect.disabled = true;
        subBankSelect.innerHTML = '<option value="">è«‹å…ˆé¸ä¸»é¡Œâ€¦</option>';
        return;
      }

      const æ¬¡åˆ—è¡¨ = Object.keys(window.åˆ†é¡æ¨¹?.[ä¸»åˆ†é¡]?.[å­åˆ†é¡] || {});
      subBankSelect.disabled = false;
      subBankSelect.appendChild(new Option("è«‹é¸è€ƒè©¦é …ç›®â€¦", ""));
      let æœ‰ä»»ä½•å¯è€ƒçš„ = false;
      for(const æ¬¡åˆ†é¡ of æ¬¡åˆ—è¡¨){
        const bankKey = window.åˆ†é¡æ¨¹?.[ä¸»åˆ†é¡]?.[å­åˆ†é¡]?.[æ¬¡åˆ†é¡] || "";
        if(!bankKey) continue;
        if(é¡Œåº«è¶³å¤ (bankKey)){
          subBankSelect.appendChild(new Option(æ¬¡åˆ†é¡, æ¬¡åˆ†é¡));
          æœ‰ä»»ä½•å¯è€ƒçš„ = true;
        }
      }
      if(!æœ‰ä»»ä½•å¯è€ƒçš„){
        subBankSelect.disabled = true;
        subBankSelect.innerHTML = '<option value="">ï¼ˆæ­¤å­åˆ†é¡æ²’æœ‰é” 20 é¡Œçš„é¡Œåº«ï¼‰</option>';
        startBtn.disabled = true;
      }
    });

    subBankSelect.addEventListener("change", () => {
      clearToast();
      const ä¸»åˆ†é¡ = mainSelect.value;
      const å­åˆ†é¡ = bankSelect.value;
      const æ¬¡åˆ†é¡ = subBankSelect.value;
      currentBankKey = window.åˆ†é¡æ¨¹?.[ä¸»åˆ†é¡]?.[å­åˆ†é¡]?.[æ¬¡åˆ†é¡] || "";
      currentBankName = (ä¸»åˆ†é¡ && å­åˆ†é¡ && æ¬¡åˆ†é¡) ? `${ä¸»åˆ†é¡}ï½œ${å­åˆ†é¡}ï½œ${æ¬¡åˆ†é¡}` : "";

      startBtn.disabled = !æ¬¡åˆ†é¡;

      // âœ… é¸åˆ°æ¬¡åˆ†é¡ï¼šè©¦ç…‰å¤§å»³æ‰é¡¯ç¤ºæ’è¡Œæ¦œ
      if(hallMode === "exam" && æ¬¡åˆ†é¡ && currentBankKey){
        leaderBtn.style.display = "inline-flex";
      }else{
        leaderBtn.style.display = "none";
      }
    });

    leaderBtn.addEventListener("click", async () => {
      clearToast();
      if(!currentBankKey){ showToast("è«‹å…ˆé¸æ“‡æ¬¡åˆ†é¡ï¼ˆç¬¬ä¸‰å±¤ï¼‰ã€‚", "bad"); return; }
      await loadLeaderboard(currentBankKey, currentBankName);
      openLbModal();
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "./index.html";
    });

    closeBtn.addEventListener("click", () => closeModal());
    modal.addEventListener("click", (e) => { if(e.target === modal) closeModal(); });

    // è¤‡ç¿’ modal
    function openRvModal(){
      rvModal.classList.add("show");
      rvModal.setAttribute("aria-hidden", "false");
    }
    function closeRvModal(){
      stopAudio();
      rvModal.classList.remove("show");
      rvModal.setAttribute("aria-hidden", "true");
    }
    rvCloseBtn.addEventListener("click", closeRvModal);
    rvCloseBtn2.addEventListener("click", closeRvModal);
    rvModal.addEventListener("click", (e) => { if(e.target === rvModal) closeRvModal(); });

    // æ’è¡Œæ¦œ modal
    lbCloseBtn.addEventListener("click", () => closeLbModal());
    lbModal.addEventListener("click", (e) => { if(e.target === lbModal) closeLbModal(); });
    lbRefreshBtn.addEventListener("click", () => loadLeaderboard(currentBankKey, currentBankName));

    function openModal(){
      modal.classList.add("show");
      modal.setAttribute("aria-hidden", "false");
    }
    function closeModal(){
      stopAudio();
      if(autoNextTimer){ clearTimeout(autoNextTimer); autoNextTimer = null; }
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden", "true");
    }

    function openLbModal(){
      lbModal.classList.add("show");
      lbModal.setAttribute("aria-hidden", "false");
    }
    function closeLbModal(){
      lbModal.classList.remove("show");
      lbModal.setAttribute("aria-hidden", "true");
    }

    // RTDB key ä¸èƒ½å« . # $ [ ] /
    function safeKey(key){
      return String(key).replace(/[.#$\[\]\/]/g, "_");
    }

    // ===== è€ƒè©¦å¼•æ“ =====
    const TOTAL_Q = é¡Œæ•¸é–€æª»;
    let exam = null;
    let currentUser = null; // { uid, name, email, avatar }
    let currentBankKey = "";
    let currentBankName = "";
    let autoNextTimer = null;

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function pickQuestions(bankKey){
      const bank = window.QUESTION_BANK?.[bankKey];
      if(!Array.isArray(bank) || bank.length === 0) return null;
      const picked = shuffle(bank).slice(0, Math.min(TOTAL_Q, bank.length));

      // âœ… æ¯é¡Œé¸é …ä¹Ÿæ´—ç‰Œï¼ˆä¸¦åŒæ­¥ä¿®æ­£æ­£ç¢ºç­”æ¡ˆç´¢å¼•ï¼‰
      return picked.map((q) => {
        const qq = { ...q };

        const opts = Array.isArray(qq.options) ? qq.options.slice() : [];
        const correct = Number.isInteger(qq.answer) ? qq.answer : -1;

        if(opts.length > 1 && correct >= 0 && correct < opts.length){
          const idxs = Array.from({length: opts.length}, (_, i) => i);
          const shuffledIdxs = shuffle(idxs);
          qq.options = shuffledIdxs.map(i => opts[i]);     // âœ… ç›´æ¥æ¬æ•´å€‹ itemï¼ˆå­—ä¸²æˆ–ç‰©ä»¶éƒ½è¡Œï¼‰
          qq.answer  = shuffledIdxs.indexOf(correct);
        }else{
          qq.options = opts;
        }
        return qq;
      });
    }

    function renderQuestion(){
      const i = exam.index;
      const q = exam.questions[i];

      modalTitle.textContent = "ä½œç­”ä¸­";
      modalSub.textContent = `é¡Œåº«ï¼š${exam.bankName}ï½œæŠ½é¡Œï¼š${exam.questions.length} é¡Œï½œæ¯é¡Œ 5 åˆ†`;

      qIndex.textContent = `ç¬¬ ${i+1} / ${exam.questions.length} é¡Œ`;
      scoreBadge.textContent = `${exam.score} åˆ†`;

      qText.textContent = q.text || "(ç„¡é¡Œç›®æ–‡å­—)";
      opts.innerHTML = "";
      nextBtn.disabled = true;

      if(q.image){
        qImg.style.display = "block";
        qImgTag.src = q.image;
      }else{
        qImg.style.display = "none";
        qImgTag.removeAttribute("src");
      }

      // âœ… éŸ³æª”æ’­æ”¾ï¼ˆé¡Œåº«å¯æä¾› q.audioï¼‰
      stopAudio();
      if(q.audio){
        playBtn.style.display = "inline-flex";
        playBtn.onclick = () => {
          try{
            stopAudio();
            audioPlayer = new Audio(q.audio);
            audioPlayer.play();
          }catch(e){
            showToast("éŸ³è¨Šæ’­æ”¾å¤±æ•—ï¼ˆæª”æ¡ˆè·¯å¾‘æˆ–ç€è¦½å™¨é™åˆ¶ï¼‰", "bad");
          }
        };
      }else{
        playBtn.style.display = "none";
        playBtn.onclick = null;
      }

      // é¸é …
      (q.options || []).forEach((optItem, idx) => {
        const btn = document.createElement("button");
        btn.className = "opt";
        btn.type = "button";

        const label = (typeof optItem === "object" && optItem) ? (optItem.label ?? "") : String(optItem ?? "");
        const audio = (typeof optItem === "object" && optItem) ? (optItem.audio ?? "") : "";

        // å·¦é‚Šæ–‡å­—ã€å³é‚ŠèªéŸ³éˆ•
        btn.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div style="flex:1; min-width:0;">${label}</div>
            ${audio ? `<button class="btn" type="button" data-audio="${escapeHtml(audio)}" style="padding:6px 10px;">ğŸ”Š</button>` : ""}
          </div>
        `;

        // é»æ•´å€‹é¸é … = ä½œç­”
        btn.addEventListener("click", (e) => {
          // å¦‚æœé»åˆ°èªéŸ³æŒ‰éˆ•ï¼Œåˆ¥è§¸ç™¼ä½œç­”
          const audioBtn = e.target.closest?.("button[data-audio]");
          if(audioBtn) return;
          choose(idx, btn);
        });

        // èªéŸ³æŒ‰éˆ•äº‹ä»¶
        const audioBtn = btn.querySelector("button[data-audio]");
        if(audioBtn){
          audioBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            try{
              stopAudio();
              audioPlayer = new Audio(audioBtn.dataset.audio);
              audioPlayer.play();
            }catch(err){
              showToast("é¸é …èªéŸ³æ’­æ”¾å¤±æ•—ï¼ˆæª”æ¡ˆè·¯å¾‘æˆ–ç€è¦½å™¨é™åˆ¶ï¼‰", "bad");
            }
          });
        }

        opts.appendChild(btn);
      });

      report.style.display = "none";
    }

    function choose(choiceIndex, clickedBtn){
      if(exam.answered[exam.index]) return; // prevent double

      const q = exam.questions[exam.index];
      const correct = q.answer;
      const isRight = (choiceIndex === correct);

      exam.answered[exam.index] = true;
      exam.userAnswers[exam.index] = choiceIndex;

      // æ¨™ç¤ºå°éŒ¯
      const buttons = Array.from(opts.querySelectorAll(".opt"));
      buttons.forEach((b, idx) => {
        if(idx === correct) b.classList.add("correct");
        if(idx === choiceIndex && !isRight) b.classList.add("wrong");
        b.disabled = true;
      });

      if(isRight) exam.score += exam.perPoint;

      scoreBadge.textContent = `${exam.score} åˆ†`;
      nextBtn.disabled = false;

      // æœ€å¾Œä¸€é¡Œï¼ŒæŠŠ nextBtn è®Šæˆã€Œå®Œæˆä¸¦çœ‹å ±å‘Šã€
      if(exam.index === exam.questions.length - 1){
        nextBtn.textContent = "å®Œæˆä¸¦æŸ¥çœ‹å ±å‘Š";
      }

      // âœ… 2 ç§’å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œï¼ˆæœ€å¾Œä¸€é¡Œè‡ªå‹•å®Œæˆä¸¦æŸ¥çœ‹å ±å‘Šï¼‰
      if(autoNextTimer){ clearTimeout(autoNextTimer); }
      autoNextTimer = setTimeout(() => {
        autoNextTimer = null;
        if(!exam) return;
        if(exam.index < exam.questions.length - 1){
          exam.index++;
          renderQuestion();
        }else{
          showReport();
        }
      }, 2000);
    }

    function showReport(){
      // âœ… è€ƒå®Œè‡ªå‹•å¯«å…¥æ’è¡Œæ¦œ
      try{ saveScoreToLeaderboard(exam.bankKey, exam.bankName, exam.score); }catch(e){}

      modalTitle.textContent = "å®Œæˆ âœ…";
      modalSub.textContent = `ç¸½åˆ†ï¼š${exam.score} / 100ï½œé¡Œåº«ï¼š${exam.bankName}`;

      reportList.innerHTML = "";
      exam.questions.forEach((q, i) => {
        const ua = exam.userAnswers[i];
        const ca = q.answer;

      function optLabel(x){
          if(typeof x === "object" && x) return String(x.label ?? "");
          return stripHtml(String(x ?? ""));
        }
        const uaText = ua == null ? "æœªä½œç­”" : optLabel(q.options[ua]);
        const caText = optLabel(q.options[ca]);

        const line = document.createElement("div");
        line.className = "rline";
        line.innerHTML = `
          <div><b>ç¬¬ ${i+1} é¡Œ</b> <span class="muted">${escapeHtml(q.text || "")}</span></div>
          <div>ä½ çš„ç­”æ¡ˆï¼š${escapeHtml(uaText)} ${ua===ca ? "âœ…" : "âŒ"}</div>
          <div>æ­£ç¢ºç­”æ¡ˆï¼š${escapeHtml(caText)}</div>
        `;
        reportList.appendChild(line);
      });

      report.style.display = "block";
      nextBtn.disabled = true;
      nextBtn.textContent = "å·²å®Œæˆ";
    }

    nextBtn.addEventListener("click", () => {
      if(autoNextTimer){ clearTimeout(autoNextTimer); autoNextTimer = null; }
      if(!exam) return;
      if(exam.index < exam.questions.length - 1){
        exam.index++;
        renderQuestion();
      }else{
        showReport();
      }
    });

    function stripHtml(s){
      const div = document.createElement("div");
      div.innerHTML = s ?? "";
      return (div.textContent || div.innerText || "").trim();
    }

    async function updateUserProgress(bankKey, bankName, score){
      if(!currentUser || !bankKey) return;
      const k = safeKey(bankKey);
      const now = Date.now();
      const userRef = ref(db, "users/" + currentUser.uid);

      try{
        const result = await runTransaction(userRef, (cur) => {
          cur = cur || {};
          const scores = cur.examScores || {};
          const prev = Number(scores?.[k]?.score || 0);

          // è¦†è“‹æœ€æ–°åˆ†æ•¸ï¼ˆåŒä¸€è€ƒè©¦é …ç›®åªè¨˜ä¸€æ¬¡ï¼‰
          scores[k] = {
            bankKey,
            bankName: bankName || "",
            score: Number(score || 0),
            updatedAt: now
          };

          const xpBefore = Number(cur.xpTotal || 0);
          const delta = Number(score || 0) - prev;
          const xpAfter = xpBefore + delta;

          cur.examScores = scores;
          cur.xpTotal = xpAfter;
          cur.level = calcLevel(xpAfter);
          return cur;
        });

        const v = result?.snapshot?.val() || null;
        if(v){
          currentUser.xpTotal = Number(v.xpTotal || 0);
          currentUser.level = Number(v.level || calcLevel(currentUser.xpTotal));
          // åŒæ­¥æ›´æ–° UIï¼ˆä¸é‡æ–°æŠ“ profileï¼‰
          try{
            const email = currentUser.email || "";
            const name = currentUser.name || "æ”¹é€ å¸«";
            const avatar = currentUser.avatar || "";
            userBar.innerHTML = `
              <img class="avatar" src="${escapeHtml(avatar)}" alt="avatar"/>
              <div class="usertext">
                <div>ç›®å‰ç™»å…¥ï¼š<b>${escapeHtml(name)}</b></div>
                <div class="muted" style="font-size:12px;">Lv.${currentUser.level}ï½œç¶“é©— ${currentUser.xpTotal}ï½œ${escapeHtml(email)}</div>
              </div>
            `;
          }catch(e){}
        }
      }catch(e){
        console.error("updateUserProgress failed:", e);
      }
    }
    
    async function loadLeaderboard(bankKey, bankName){
      if(!bankKey) return;
      const k = safeKey(bankKey);
      lbTitle.textContent = "æ’è¡Œæ¦œ";
      lbSub.textContent = `é¡Œåº«ï¼š${bankName || bankKey}`;
      lbList.innerHTML = "<div class=\"hint\">è¼‰å…¥ä¸­â€¦</div>";
      lbCount.textContent = "â€”";

      try{
        const qRef = query(ref(db, "leaderboards/" + k), orderByChild("latestScore"), limitToLast(50));
        const snap = await get(qRef);
        const rows = [];
        if(snap.exists()){
          snap.forEach(child => {
            const v = child.val() || {};
            rows.push({
              uid: child.key,
              name: v.name || "åŒ¿åæ”¹é€ å¸«",
              avatar: v.avatar || "",
              level: Number(v.level || 1),
              xpTotal: Number(v.xpTotal || 0),
              latestScore: typeof v.latestScore === "number" ? v.latestScore : Number(v.latestScore || 0),
              updatedAt: v.updatedAt || 0,
              attempts: v.attempts || 0
            });
          });
        }

        // limitToLast æœƒå›å‚³ç”±å°åˆ°å¤§ï¼›æˆ‘å€‘è¦ç”±å¤§åˆ°å°
        rows.sort((a,b) => (b.latestScore - a.latestScore) || (b.updatedAt - a.updatedAt));

        lbCount.textContent = `${rows.length} äºº`;

        if(rows.length === 0){
          lbList.innerHTML = "<div class=\"hint\">ç›®å‰é‚„æ²’æœ‰äººä¸Šæ¦œï½å¿«å»æ¶ç¬¬ä¸€å ğŸ˜¼</div>";
          return;
        }

        // render
        lbList.innerHTML = "";
        rows.slice(0, 20).forEach((r, idx) => {
          const item = document.createElement("div");
          item.className = "opt";
          const medal = idx===0 ? "ğŸ¥‡" : idx===1 ? "ğŸ¥ˆ" : idx===2 ? "ğŸ¥‰" : `#${idx+1}`;
          const avatar = r.avatar ? `<img class="avatar" src="${escapeHtml(r.avatar)}" alt="avatar" />` : "";
          const me = currentUser && r.uid === currentUser.uid ? "ï¼ˆä½ ï¼‰" : "";
          item.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
              ${avatar}
              <div style="flex:1; min-width:0;">
                <div style="display:flex; justify-content:space-between; gap:8px;">
                  <div style="font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${medal} ${escapeHtml(r.name)} ${me}
                  </div>
                  <div style="font-weight:900;">${r.latestScore} åˆ†</div>
                </div>
                <div class="muted" style="font-size:12px; margin-top:4px;">
                  Lv.${Number(r.level || 1)}ï½œå˜—è©¦æ¬¡æ•¸ï¼š${r.attempts || 0}
                </div>
              </div>
            </div>
          `;
          lbList.appendChild(item);
        });

      }catch(e){
        console.error("loadLeaderboard failed:", e);
        const code = e?.code ? `ï¼ˆ${e.code}ï¼‰` : "";
        const msg  = e?.message ? e.message : String(e);
        lbList.innerHTML = `<div class="hint">æ’è¡Œæ¦œè¼‰å…¥å¤±æ•— ${code}<br/>${msg}</div>`;
        lbCount.textContent = "â€”";
      }

    }

    async function saveScoreToLeaderboard(bankKey, bankName, score){
      if(!currentUser || !bankKey) return;
      const k = safeKey(bankKey);
      const userRef = ref(db, "leaderboards/" + k + "/" + currentUser.uid);

      try{
        const snap = await get(userRef);
        const now = Date.now();
        const existing = snap.exists() ? (snap.val() || {}) : {};
        const attempts = Number(existing.attempts || 0) + 1;

        
        

        // è¦å‰‡ï¼šæ’è¡Œæ¦œåªè¨˜éŒ„ã€Œæœ€æ–°åˆ†æ•¸ã€ï¼ˆä¸ä¿ç•™æœ€é«˜åˆ†ï¼‰
        const latestScore = Number(score || 0);

        // âœ… å…ˆåŒæ­¥å¯«å…¥ç”¨æˆ¶ç¶“é©— / ç­‰ç´šï¼ˆæœƒæ›´æ–° currentUser.xpTotal / currentUser.levelï¼‰
        try{ await updateUserProgress(bankKey, bankName, latestScore); }catch(e){}

        await update(userRef, {
          bankKey,
          bankName: bankName || "",
          uid: currentUser.uid,
          name: currentUser.name || "æ”¹é€ å¸«",
          avatar: currentUser.avatar || "",
          latestScore,
          attempts,
          updatedAt: now,
          // âœ… æ’è¡Œæ¦œé¡å¤–é¡¯ç¤ºç”¨
          level: Number(currentUser?.level || 1),
          xpTotal: Number(currentUser?.xpTotal || 0)
        });
      }catch(e){
        console.error("saveScoreToLeaderboard failed:", e);
        if(!saveScoreToLeaderboard._warned){
          saveScoreToLeaderboard._warned = true;
          showToast("åˆ†æ•¸å¯«å…¥æ’è¡Œæ¦œå¤±æ•—ï¼ˆå¤šåŠæ˜¯ Firebase Rules æˆ– Pages ç¶²åŸŸæœªæˆæ¬Šï¼‰", "bad");
        }
      }
    }


    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }


    function getReviewItems(bankKey){
      const bank = window.QUESTION_BANK?.[bankKey];
      if(!Array.isArray(bank)) return [];
      return bank.map((q, idx) => {
        const ansIdx = Number.isInteger(q.answer) ? q.answer : -1;
        const opt = (Array.isArray(q.options) && ansIdx >= 0) ? q.options[ansIdx] : null;

        const label = (typeof opt === "object" && opt) ? (opt.label ?? "") : (opt != null ? String(opt) : "");
        const audio = (typeof opt === "object" && opt) ? (opt.audio ?? "") : (q.audio ?? "");

        return {
          idx: idx + 1,
          prompt: q.text || "",
          text: label || "",
          audio: audio || ""
        };
      }).filter(x => x.text || x.prompt);
    }

    async function openReview(bankKey, bankName){
      rvTitle.textContent = "è¤‡ç¿’";
      rvSub.textContent = `é¡Œåº«ï¼š${bankName || bankKey}`;
      rvList.innerHTML = "";
      const items = getReviewItems(bankKey);
      rvCount.textContent = `${items.length} ç­†`;

      if(items.length === 0){
        rvList.innerHTML = '<div class="hint">é€™å€‹é¡Œåº«æ²’æœ‰å¯é¡¯ç¤ºçš„è¤‡ç¿’å…§å®¹ã€‚</div>';
        openRvModal();
        return;
      }

      items.forEach((it) => {
        const row = document.createElement("div");
        row.className = "opt";
        row.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div style="flex:1; min-width:0;">
              <div style="font-weight:900; font-size:16px; line-height:1.35; overflow-wrap:anywhere;">${escapeHtml(it.text)}</div>
              ${it.prompt ? `<div class="muted" style="font-size:12px; margin-top:6px; line-height:1.4;">${escapeHtml(it.prompt)}</div>` : ``}
            </div>
            ${it.audio ? `<button class="btn" type="button" data-audio="${escapeHtml(it.audio)}" style="padding:6px 10px;">ğŸ”Š</button>` : ``}
          </div>
        `;

        // é»æ•´è¡Œï¼šè¤‡è£½æ–‡å­—ï¼ˆæ–¹ä¾¿ä¸Ÿçµ¦ AI ç¿»è­¯ï¼‰
        row.addEventListener("click", (e) => {
          const audioBtn = e.target.closest?.("button[data-audio]");
          if(audioBtn) return;
          const t = it.text || "";
          if(!t) return;
          navigator.clipboard?.writeText(t);
          showToast(`å·²è¤‡è£½ï¼š${t}`, "ok");
        });

        const audioBtn = row.querySelector("button[data-audio]");
        if(audioBtn){
          audioBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            try{
              stopAudio();
              audioPlayer = new Audio(audioBtn.dataset.audio);
              audioPlayer.play();
            }catch(err){
              showToast("èªéŸ³æ’­æ”¾å¤±æ•—ï¼ˆæª”æ¡ˆè·¯å¾‘æˆ–ç€è¦½å™¨é™åˆ¶ï¼‰", "bad");
            }
          });
        }

        rvList.appendChild(row);
      });

      openRvModal();
    }

    startBtn.addEventListener("click", () => {
      clearToast();
      const ä¸»åˆ†é¡ = mainSelect.value;
      const å­åˆ†é¡ = bankSelect.value;
      const æ¬¡åˆ†é¡ = subBankSelect.value;
      const bankKey = window.åˆ†é¡æ¨¹?.[ä¸»åˆ†é¡]?.[å­åˆ†é¡]?.[æ¬¡åˆ†é¡] || "";
      if(!bankKey) return;

      currentBankKey = bankKey;
      currentBankName = `${ä¸»åˆ†é¡}ï½œ${å­åˆ†é¡}ï½œ${æ¬¡åˆ†é¡}`;

      if(hallMode === "review"){
        // è¤‡ç¿’å¤§å»³ï¼šä¸éœ€è¦æ»¿ 20 é¡Œï¼ˆä½†ä»é ˆæœ‰é¡Œåº«ï¼‰
        const bank = window.QUESTION_BANK?.[bankKey];
        if(!Array.isArray(bank) || bank.length === 0){
          showToast("æ­¤é¡Œåº«æ²’æœ‰å…§å®¹ï¼Œç„¡æ³•è¤‡ç¿’ã€‚", "bad");
          return;
        }
        openReview(bankKey, currentBankName);
        return;
      }

      // ===== è©¦ç…‰å¤§å»³ï¼ˆåŸæœ¬è€ƒè©¦ï¼‰=====
      if(!é¡Œåº«è¶³å¤ (bankKey)){
        showToast("æ­¤é¡Œåº«æœªæ»¿ 20 é¡Œï¼Œæš«ä¸é–‹æ”¾è€ƒè©¦ã€‚", "bad");
        return;
      }

      const picked = pickQuestions(bankKey);
      if(!picked){
        showToast("é€™å€‹é¡Œåº«ç›®å‰æ²’æœ‰é¡Œç›®ï¼ˆæˆ–é‚„æ²’è¼‰å…¥é¡Œåº« JSï¼‰ã€‚", "bad");
        return;
      }

      const bankName = `${ä¸»åˆ†é¡}ï½œ${å­åˆ†é¡}ï½œ${æ¬¡åˆ†é¡}`;

      exam = {
        bankKey,
        bankName,
        questions: picked,
        index: 0,
        score: 0,
        perPoint: 5, // 20 é¡Œ â†’ æ¯é¡Œ 5 åˆ† â†’ 100
        answered: Array(picked.length).fill(false),
        userAnswers: Array(picked.length).fill(null)
      };

      nextBtn.textContent = "ä¸‹ä¸€é¡Œ";
      openModal();
      renderQuestion();
    });

    // ===== Auth æª¢æŸ¥ï¼šæ²’ç™»å…¥å°±å›ç™»å…¥é  =====
    onAuthStateChanged(auth, async (user) => {
      if(!user){
        window.location.href = "./index.html";
        return;
      }

      // é¡¯ç¤ºä¸­æ–‡åï¼šè®€ RTDB users/<uid>
      try{
        const snap = await get(ref(db, "users/" + user.uid));
        const profile = snap.exists() ? snap.val() : null;
        const name = profile?.username || user.displayName || "æ”¹é€ å¸«";
        const avatar = profile?.avatar || `https://picsum.photos/seed/${user.uid}/80/80`;
        const xpTotal = Number(profile?.xpTotal || 0);
        const level = Number(profile?.level || calcLevel(xpTotal));
        currentUser = { uid: user.uid, name, email: user.email, avatar, xpTotal, level };
        userBar.innerHTML = `
          <img class="avatar" src="${escapeHtml(avatar)}" alt="avatar"/>
          <div class="usertext">
            <div>ç›®å‰ç™»å…¥ï¼š<b>${escapeHtml(name)}</b></div>
            <div class="muted" style="font-size:12px;">Lv.${level}ï½œç¶“é©— ${xpTotal}ï½œ${escapeHtml(user.email || "")}</div>
          </div>
        `;
}catch(e){
        const name = user.displayName || "æ”¹é€ å¸«";
        const avatar = `https://picsum.photos/seed/${user.uid}/80/80`;
        currentUser = { uid: user.uid, name, email: user.email, avatar, xpTotal:0, level:1 };
        userBar.innerHTML = `
          <img class="avatar" src="${escapeHtml(avatar)}" alt="avatar"/>
          <div class="usertext">
            <div>ç›®å‰ç™»å…¥ï¼š<b>${escapeHtml(name)}</b></div>
            <div class="muted" style="font-size:12px;">Lv.1ï½œç¶“é©— 0ï½œ${escapeHtml(user.email || "")}</div>
          </div>
        `;
      }
    });

    // init
    initTreeUI();

    // ä½ ç¾åœ¨çš„é¡Œåº« key ç¯„ä¾‹ï¼šwork-pre / work-review / work-flow / work-rule// ä¹‹å¾Œä½ åªè¦æŠŠ åˆ†é¡æ¨¹ è£¡çš„ banks key æ›æˆä½ æ–°å¢é¡Œåº«çš„ key å°±è¡Œã€‚
  </script>
</body>
</html>
